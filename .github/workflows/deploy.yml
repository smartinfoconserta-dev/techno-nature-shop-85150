name: Deploy do site na Hostinger via FTPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar o reposit√≥rio
        uses: actions/checkout@v3

      - name: Instalar Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Instalar depend√™ncias
        run: npm install

      - name: Validar secrets de FTP obrigat√≥rios
        run: |
          echo "üîç Validando secrets de FTP..."
          missing=0
          
          # Validar apenas secrets do FTP (obrigat√≥rios)
          if [ -z "${{ secrets.FTP_HOST }}" ]; then
            echo "‚ùå ERRO: FTP_HOST n√£o definido!"
            missing=1
          else
            echo "‚úÖ FTP_HOST definido: ${{ secrets.FTP_HOST }}"
          fi
          
          if [ -z "${{ secrets.FTP_USER }}" ]; then
            echo "‚ùå ERRO: FTP_USER n√£o definido!"
            missing=1
          else
            echo "‚úÖ FTP_USER definido"
          fi
          
          if [ -z "${{ secrets.FTP_PASS }}" ]; then
            echo "‚ùå ERRO: FTP_PASS n√£o definido!"
            missing=1
          else
            echo "‚úÖ FTP_PASS definido (oculto)"
          fi
          
          # FTP_SERVER_DIR √© opcional, usar / como padr√£o (raiz da conta FTP)
          # Hostinger FTP j√° inicia na raiz onde existe public_html
          if [ -z "${{ secrets.FTP_SERVER_DIR }}" ]; then
            echo "‚ö†Ô∏è FTP_SERVER_DIR n√£o definido, usando / como padr√£o (raiz FTP)"
            echo "DEPLOY_PATH=/" >> $GITHUB_ENV
          else
            echo "‚úÖ FTP_SERVER_DIR definido: ${{ secrets.FTP_SERVER_DIR }}"
            echo "DEPLOY_PATH=${{ secrets.FTP_SERVER_DIR }}" >> $GITHUB_ENV
          fi
          
          if [ "$missing" -eq 1 ]; then
            echo ""
            echo "‚ùå Secrets de FTP obrigat√≥rios est√£o faltando!"
            echo "üìù Configure em: Settings > Secrets and variables > Actions"
            echo "   - FTP_HOST (ex: 147.93.64.216)"
            echo "   - FTP_USER (ex: u728860321)"
            echo "   - FTP_PASS (sua senha FTP)"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Todos os secrets de FTP configurados!"

      - name: Detectar ou criar .env
        run: |
          echo "üîç Verificando arquivo .env..."
          
          if [ -f .env ] && [ -s .env ]; then
            echo "‚úÖ Arquivo .env encontrado no reposit√≥rio, usando existente."
            cat .env
          else
            echo "‚ö†Ô∏è Arquivo .env n√£o encontrado ou vazio."
            
            # Tentar criar a partir dos secrets (se existirem)
            if [ -n "${{ secrets.VITE_SUPABASE_URL }}" ]; then
              echo "üìù Criando .env a partir dos secrets GitHub..."
              echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" > .env
              echo "VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}" >> .env
              echo "VITE_SUPABASE_PROJECT_ID=${{ secrets.VITE_SUPABASE_PROJECT_ID }}" >> .env
              echo "‚úÖ Arquivo .env criado com sucesso"
            else
              echo "‚ö†Ô∏è Secrets VITE_SUPABASE_* n√£o definidos, build usar√° vari√°veis padr√£o"
            fi
          fi

      - name: Testar conex√£o FTP
        run: |
          echo "üîê Testando login FTPS em ${{ secrets.FTP_HOST }}..."
          echo "üìÅ Caminho de deploy: ${{ env.DEPLOY_PATH }}"
          
          # Testar conex√£o FTPS com curl (porta 21, ssl-reqd)
          curl -v --ssl-reqd --ftp-ssl -k \
            --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" \
            "ftp://${{ secrets.FTP_HOST }}${{ env.DEPLOY_PATH }}" 2>&1 | tee ftp_test.log
          
          # Verificar se houve erro 530 (login incorreto)
          if grep -q "530" ftp_test.log; then
            echo ""
            echo "‚ùå ERRO 530: Login FTP incorreto!"
            echo "üîç Verifique no GitHub Secrets:"
            echo "   - FTP_HOST = apenas IP ou dom√≠nio (SEM ftp://)"
            echo "   - FTP_USER = usu√°rio FTP correto"
            echo "   - FTP_PASS = senha FTP correta"
            echo ""
            echo "üí° Teste suas credenciais em FileZilla/WinSCP primeiro!"
            exit 1
          fi
          
          echo "‚úÖ Conex√£o FTPS bem-sucedida!"
        continue-on-error: false

      - name: Listar diret√≥rio remoto
        run: |
          echo "üìÇ Listando conte√∫do de ${{ env.DEPLOY_PATH }}..."
          curl -v --ssl-reqd --ftp-ssl -k \
            --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" \
            "ftp://${{ secrets.FTP_HOST }}${{ env.DEPLOY_PATH }}" || echo "‚ö†Ô∏è N√£o foi poss√≠vel listar. Verifique permiss√µes."
        continue-on-error: true

      - name: Fazer o build (compilar site)
        run: npm run build

      - name: Verificar arquivos do build
        run: |
          echo "üì¶ Arquivos gerados em dist/:"
          ls -alh dist/

      - name: Enviar o site pra Hostinger via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          protocol: ftps
          port: 21
          local-dir: dist/
          server-dir: ${{ env.DEPLOY_PATH }}
          dangerous-clean-slate: true
          dry-run: false
          log-level: verbose

      - name: Verificar site online
        run: |
          echo "üåê Testando site em https://ramontech.com.br..."
          STATUS=$(curl -I -s -o /dev/null -w "%{http_code}" https://ramontech.com.br || echo "000")
          echo "üîé Status HTTP: $STATUS"
          
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ] || [ "$STATUS" = "302" ]; then
            echo "‚úÖ Site acess√≠vel com sucesso!"
          else
            echo "‚ö†Ô∏è Site n√£o respondeu corretamente. Aguarde propaga√ß√£o ou verifique configura√ß√£o."
          fi
