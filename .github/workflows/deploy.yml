name: üöÄ Deploy do site na Hostinger via FTPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: üîç Verificar reposit√≥rio
        uses: actions/checkout@v4

      - name: ‚öôÔ∏è Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: üì¶ Instalar depend√™ncias
        run: npm ci

      - name: üìù Incrementar vers√£o da aplica√ß√£o
        run: |
          VERSION=$(date +%Y.%m.%d.%H%M)
          cat > src/lib/appVersion.ts <<'EOF'
          const APP_VERSION = "$VERSION";

          export function getCurrentVersion() {
            return APP_VERSION;
          }

          export function clearAllCache() {
            console.log('üßπ Limpando cache manualmente...');
            
            try {
              localStorage.clear();
              sessionStorage.clear();
              
              if ('caches' in window) {
                caches.keys().then(names => {
                  names.forEach(name => caches.delete(name));
                });
              }
              
              setTimeout(() => {
                window.location.href = window.location.href.split('?')[0] + '?t=' + Date.now();
              }, 100);
            } catch (error) {
              console.error('Erro ao limpar cache:', error);
              window.location.reload();
            }
          }
          EOF
          sed -i "s/\$VERSION/$VERSION/g" src/lib/appVersion.ts
          echo "‚úÖ Vers√£o definida: $VERSION"

      - name: üèóÔ∏è Buildar projeto
        run: npm run build

      - name: üîÑ Adicionar timestamp anti-cache no HTML
        run: |
          TIMESTAMP=$(date +%s)
          BUILD_ID=$(date +%Y%m%d-%H%M%S)
          
          echo "üî® Injetando timestamp $TIMESTAMP no index.html..."
          
          # Adicionar meta tags √∫nicas
          sed -i "s|</head>|<meta name=\"build-id\" content=\"$BUILD_ID\" /><meta name=\"cache-buster\" content=\"$TIMESTAMP\" /></head>|g" dist/index.html
          
          # Adicionar coment√°rio √∫nico no final do HTML
          echo "<!-- üèóÔ∏è Build ID: $BUILD_ID | Timestamp: $TIMESTAMP | Anti-Cache: TRUE -->" >> dist/index.html
          
          echo "‚úÖ HTML modificado com sucesso"
          echo "üìä Build ID: $BUILD_ID"
          echo "‚è∞ Timestamp: $TIMESTAMP"

      - name: üîê Validar secrets obrigat√≥rios
        run: |
          if [ -z "${{ secrets.FTP_HOST }}" ] || [ -z "${{ secrets.FTP_USER }}" ] || [ -z "${{ secrets.FTP_PASS }}" ]; then
            echo "‚ùå ERRO: Secrets FTP obrigat√≥rios ausentes!"
            exit 1
          fi
          echo "‚úÖ Secrets FTP detectados com sucesso."

      - name: üóÇÔ∏è Definir caminho de deploy
        run: |
          if [ -z "${{ secrets.FTP_SERVER_DIR }}" ]; then
            echo "‚öôÔ∏è Usando DEPLOY_PATH=/ (raiz do FTP)"
            echo "DEPLOY_PATH=/" >> $GITHUB_ENV
          else
            RAW="${{ secrets.FTP_SERVER_DIR }}"
            # Remove "./" e garante formato "/path/"
            NORM="/${RAW#./}"
            NORM="/${NORM#/}"
            case "$NORM" in */) ;; *) NORM="$NORM/";; esac
            
            if echo "$NORM" | grep -q "public_html/public_html"; then
              echo "‚ùå Caminho inv√°lido: $NORM"
              exit 1
            fi
            
            echo "‚úÖ Caminho de deploy definido: $NORM"
            echo "DEPLOY_PATH=$NORM" >> $GITHUB_ENV
          fi

      - name: üîé Testar login FTP
        run: |
          echo "üîç Testando conex√£o FTPS..."
          curl -v --ssl-reqd --ftp-ssl --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" "ftp://${{ secrets.FTP_HOST }}" || true

      - name: üìÇ Listar diret√≥rio remoto antes do deploy
        run: |
          echo "üìÅ Listando conte√∫do atual em ${{ env.DEPLOY_PATH }}"
          curl -v --ssl-reqd --ftp-ssl --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" "ftp://${{ secrets.FTP_HOST }}${{ env.DEPLOY_PATH }}" || true

      - name: üöÄ Enviar site pra Hostinger via FTPS
        id: deploy
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          port: 21
          protocol: ftps
          server-dir: ${{ env.DEPLOY_PATH }}
          local-dir: dist/
          log-level: verbose
          dangerous-clean-slate: true

      - name: üßæ Listar diret√≥rio remoto ap√≥s deploy
        run: |
          echo "üìÇ Conte√∫do final no servidor:"
          curl -v --ssl-reqd --ftp-ssl --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" "ftp://${{ secrets.FTP_HOST }}${{ env.DEPLOY_PATH }}" || true

      # =============================
      # üåê TESTES AP√ìS DEPLOY
      # =============================

      - name: üåç Testar site online (for√ßando SSL inseguro)
        run: |
          echo "üåç Verificando status HTTPS (ignorando certificado inv√°lido)..."
          curl -k -I -L https://ramontech.com.br || true

      - name: üß† Validar HTML e anti-cache
        run: |
          echo "üß© Verificando conte√∫do do site..."
          HTML=$(curl -ksL https://ramontech.com.br/index.html || true)
          if echo "$HTML" | grep -q "<title>Ramon Tech"; then
            echo "‚úÖ P√°gina carregada corretamente"
          else
            echo "‚ö†Ô∏è Aviso: conte√∫do n√£o corresponde ao esperado (pode ser cache antigo)"
          fi

          echo "‚öôÔ∏è Adicionando cabe√ßalhos anti-cache..."
          cat > ./dist/.htaccess <<'EOF'
          <IfModule mod_headers.c>
            Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
            Header set Pragma "no-cache"
            Header set Expires 0
          </IfModule>
          <FilesMatch "\.(html|js|css|json|png|jpg|jpeg|svg|ico|webmanifest)$">
            Header set Cache-Control "no-store, no-cache, must-revalidate, max-age=0"
          </FilesMatch>
          <IfModule mod_rewrite.c>
            RewriteEngine On
            RewriteBase /
            RewriteCond %{REQUEST_FILENAME} !-f
            RewriteCond %{REQUEST_FILENAME} !-d
            RewriteRule . /index.html [L]
          </IfModule>
          EOF

      # =============================
      # üß© DIAGN√ìSTICO DE ERROS
      # =============================
      - name: ‚ùó Diagn√≥stico de erros de deploy
        if: failure()
        run: |
          echo "‚ö†Ô∏è Analisando logs de erro..."
          LOGS=$(cat $GITHUB_WORKSPACE/* || true)

          if echo "$LOGS" | grep -q "530"; then
            echo "‚ùå ERRO 530: Falha de login no FTP (usu√°rio ou senha incorretos)"
          elif echo "$LOGS" | grep -q "550"; then
            echo "‚ùå ERRO 550: Permiss√£o negada ou diret√≥rio inexistente no servidor"
          elif echo "$LOGS" | grep -q "425"; then
            echo "‚ùå ERRO 425: Conex√£o n√£o estabelecida com o servidor"
          elif echo "$LOGS" | grep -q "Timed out"; then
            echo "‚è∞ ERRO: Tempo de conex√£o excedido"
          elif echo "$LOGS" | grep -q "ENOTFOUND"; then
            echo "üåê ERRO: Host FTP n√£o encontrado ‚Äî verifique o FTP_HOST"
          else
            echo "‚öôÔ∏è Nenhum erro padr√£o detectado. Veja os logs acima para detalhes t√©cnicos."
          fi
