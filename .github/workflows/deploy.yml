name: Deploy Hostinger via FTPS

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Clonar o reposit√≥rio
        uses: actions/checkout@v3

      - name: Instalar o Node
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Validar secrets obrigat√≥rios
        run: |
          echo "üîç Verificando secrets..."
          MISSING=false
          
          if [ -z "${{ secrets.VITE_SUPABASE_URL }}" ]; then
            echo "‚ùå VITE_SUPABASE_URL n√£o definido"
            MISSING=true
          else
            echo "‚úÖ VITE_SUPABASE_URL encontrado"
          fi
          
          if [ -z "${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}" ]; then
            echo "‚ùå VITE_SUPABASE_PUBLISHABLE_KEY n√£o definido"
            MISSING=true
          else
            echo "‚úÖ VITE_SUPABASE_PUBLISHABLE_KEY encontrado"
          fi
          
          if [ -z "${{ secrets.VITE_SUPABASE_PROJECT_ID }}" ]; then
            echo "‚ùå VITE_SUPABASE_PROJECT_ID n√£o definido"
            MISSING=true
          else
            echo "‚úÖ VITE_SUPABASE_PROJECT_ID encontrado"
          fi
          
          if [ -z "${{ secrets.FTP_HOST }}" ]; then
            echo "‚ùå FTP_HOST n√£o definido"
            MISSING=true
          else
            echo "‚úÖ FTP_HOST: ${{ secrets.FTP_HOST }}"
          fi
          
          if [ -z "${{ secrets.FTP_USER }}" ]; then
            echo "‚ùå FTP_USER n√£o definido"
            MISSING=true
          else
            echo "‚úÖ FTP_USER: ${{ secrets.FTP_USER }}"
          fi
          
          if [ -z "${{ secrets.FTP_PASS }}" ]; then
            echo "‚ùå FTP_PASS n√£o definido"
            MISSING=true
          else
            echo "‚úÖ FTP_PASS definido (senha oculta)"
          fi
          
          if [ -z "${{ secrets.FTP_SERVER_DIR }}" ]; then
            echo "‚ö†Ô∏è FTP_SERVER_DIR n√£o definido, usando /public_html/"
            echo "DEPLOY_PATH=/public_html/" >> $GITHUB_ENV
          else
            echo "‚úÖ FTP_SERVER_DIR: ${{ secrets.FTP_SERVER_DIR }}"
            echo "DEPLOY_PATH=${{ secrets.FTP_SERVER_DIR }}" >> $GITHUB_ENV
          fi
          
          if [ "$MISSING" = true ]; then
            echo ""
            echo "‚ùå Faltam secrets! Configure em: Settings > Secrets and variables > Actions"
            exit 1
          fi
          
          echo ""
          echo "‚úÖ Todos os secrets obrigat√≥rios est√£o configurados!"

      - name: Testar conex√£o FTP
        run: |
          echo "üîå Testando conex√£o FTP..."
          echo "Host: ${{ secrets.FTP_HOST }}"
          echo "User: ${{ secrets.FTP_USER }}"
          echo "Path: ${{ env.DEPLOY_PATH }}"
          echo ""
          
          curl -v --ssl --ftp-ssl-reqd \
            --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" \
            "ftp://${{ secrets.FTP_HOST }}${{ env.DEPLOY_PATH }}" \
            2>&1 | tee ftp-test.log
          
          if grep -q "230 User" ftp-test.log; then
            echo ""
            echo "‚úÖ Login FTP bem-sucedido!"
          else
            echo ""
            echo "‚ùå Falha no login FTP. Verifique as credenciais:"
            echo "   FTP_HOST deve ser: 147.93.64.216 (sem ftp://)"
            echo "   FTP_USER deve ser: u728860321"
            echo "   FTP_PASS deve estar correto"
            exit 1
          fi

      - name: Instalar pacotes do projeto
        run: npm install

      - name: Criar o arquivo .env com suas chaves
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" > .env
          echo "VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}" >> .env
          echo "VITE_SUPABASE_PROJECT_ID=${{ secrets.VITE_SUPABASE_PROJECT_ID }}" >> .env

      - name: Fazer o build (empacotar o site)
        run: npm run build

      - name: Verificar arquivos do build
        run: |
          echo "üì¶ Arquivos gerados no build:"
          ls -lh dist/
          echo ""
          echo "üìä Tamanho total:"
          du -sh dist/

      - name: Enviar o site pra Hostinger via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          port: 21
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          protocol: ftps
          local-dir: dist/
          server-dir: ${{ env.DEPLOY_PATH }}
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose

      - name: Verificar site online
        run: |
          echo "üåê Verificando https://ramontech.com.br ..."
          sleep 5
          STATUS=$(curl -I -s -o /dev/null -w "%{http_code}" https://ramontech.com.br 2>/dev/null || echo "000")
          echo "Status HTTP: $STATUS"
          
          if [ "$STATUS" = "200" ] || [ "$STATUS" = "301" ] || [ "$STATUS" = "302" ]; then
            echo "‚úÖ Site est√° acess√≠vel!"
          else
            echo "‚ö†Ô∏è Site retornou status $STATUS. Pode precisar aguardar propaga√ß√£o."
          fi
