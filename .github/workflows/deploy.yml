name: Deploy do site na Hostinger (com verifica√ß√£o de login)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar o reposit√≥rio
        uses: actions/checkout@v3

      - name: Instalar Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Instalar depend√™ncias
        run: npm install

      - name: Criar arquivo .env com vari√°veis do Supabase
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" > .env
          echo "VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}" >> .env
          echo "VITE_SUPABASE_PROJECT_ID=${{ secrets.VITE_SUPABASE_PROJECT_ID }}" >> .env

      - name: Verificar se todos os Secrets foram definidos
        run: |
          echo "üîç Verificando vari√°veis de ambiente..."
          missing=0
          for secret in FTP_HOST FTP_USER FTP_PASS FTP_SERVER_DIR; do
            if [ -z "${!secret}" ]; then
              echo "‚ùå ERRO: O secret $secret n√£o foi definido!"
              missing=1
            else
              echo "‚úÖ $secret encontrado."
            fi
          done
          if [ "$missing" -eq 1 ]; then
            echo "‚ö†Ô∏è Corrija os secrets faltantes no GitHub antes de continuar."
            exit 1
          fi
        env:
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}
          FTP_SERVER_DIR: ${{ secrets.FTP_SERVER_DIR }}

      - name: Testar login FTP antes do deploy
        run: |
          echo "üîê Testando login FTP..."
          curl -v --ssl -k --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" "ftp://${{ secrets.FTP_HOST }}" || exit 1
          echo "‚úÖ Login FTP bem-sucedido!"
        continue-on-error: false

      - name: Listar diret√≥rio remoto (public_html)
        run: |
          echo "üìÇ Listando o conte√∫do do diret√≥rio remoto..."
          curl -v --ssl -k --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" "ftp://${{ secrets.FTP_HOST }}${{ secrets.FTP_SERVER_DIR }}" || echo "‚ö†Ô∏è N√£o foi poss√≠vel listar o diret√≥rio. Verifique o caminho."
        continue-on-error: true

      - name: Fazer o build do projeto (compilar site)
        run: npm run build

      - name: Mostrar arquivos gerados
        run: ls -al dist/

      - name: Enviar o site para Hostinger via FTPS
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          protocol: ftps
          port: 21
          local-dir: dist/
          server-dir: ${{ secrets.FTP_SERVER_DIR }}
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose

      - name: Testar se o site est√° acess√≠vel
        run: |
          echo "üåê Testando site online..."
          STATUS=$(curl -I -s -o /dev/null -w "%{http_code}" https://ramontech.com.br || echo "000")
          echo "üîé C√≥digo de status: $STATUS"
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "301" ] && [ "$STATUS" != "302" ]; then
            echo "‚ö†Ô∏è O site ainda n√£o respondeu corretamente. Verifique se os arquivos foram enviados para a pasta certa."
          else
            echo "‚úÖ Site acess√≠vel com sucesso!"
          fi
