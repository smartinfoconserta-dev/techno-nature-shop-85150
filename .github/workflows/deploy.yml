name: Deploy Lovable via FTPS na Hostinger (Auto Diagn√≥stico)

on:
  push:
    branches:
      - main

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Clonar o reposit√≥rio
        uses: actions/checkout@v3

      - name: Configurar Node.js 18
        uses: actions/setup-node@v3
        with:
          node-version: '18'

      - name: Validar secrets obrigat√≥rios
        run: |
          echo "üîç Verificando secrets..."
          REQUIRED_SECRETS=("VITE_SUPABASE_URL" "VITE_SUPABASE_PUBLISHABLE_KEY" "VITE_SUPABASE_PROJECT_ID" "FTP_HOST" "FTP_USER" "FTP_PASS")
          MISSING=false
          for SECRET in "${REQUIRED_SECRETS[@]}"; do
            if [ -z "${!SECRET}" ]; then
              echo "‚ùå Erro: Secret $SECRET n√£o est√° definido."
              MISSING=true
            else
              echo "‚úÖ $SECRET encontrado."
            fi
          done
          if [ "$MISSING" = true ]; then
            echo "‚ö†Ô∏è Um ou mais secrets obrigat√≥rios est√£o ausentes. Corrija isso em Settings > Secrets > Actions."
            exit 1
          fi
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          VITE_SUPABASE_PUBLISHABLE_KEY: ${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}
          VITE_SUPABASE_PROJECT_ID: ${{ secrets.VITE_SUPABASE_PROJECT_ID }}
          FTP_HOST: ${{ secrets.FTP_HOST }}
          FTP_USER: ${{ secrets.FTP_USER }}
          FTP_PASS: ${{ secrets.FTP_PASS }}

      - name: Resolver caminho de deploy (DEPLOY_PATH)
        run: |
          if [ -n "${{ secrets.FTP_SERVER_DIR }}" ]; then
            DEPLOY_PATH="${{ secrets.FTP_SERVER_DIR }}"
            echo "üìÇ Usando caminho do secret: $DEPLOY_PATH"
          else
            DEPLOY_PATH="/domains/ramontech.com.br/public_html/"
            echo "‚ö†Ô∏è Secret FTP_SERVER_DIR n√£o definido, usando padr√£o: $DEPLOY_PATH"
          fi
          echo "DEPLOY_PATH=$DEPLOY_PATH" >> $GITHUB_ENV

      - name: Listar diret√≥rio remoto no Hostinger
        run: |
          echo "üì° Listando conte√∫do do diret√≥rio remoto ($DEPLOY_PATH)..."
          curl -v --ssl -k "ftp://${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}@${{ secrets.FTP_HOST }}$DEPLOY_PATH" || echo "‚ö†Ô∏è N√£o foi poss√≠vel listar o diret√≥rio (verifique se o caminho existe)."
        env:
          DEPLOY_PATH: ${{ env.DEPLOY_PATH }}

      - name: Instalar depend√™ncias
        run: npm install

      - name: Criar arquivo .env
        run: |
          echo "VITE_SUPABASE_URL=${{ secrets.VITE_SUPABASE_URL }}" > .env
          echo "VITE_SUPABASE_PUBLISHABLE_KEY=${{ secrets.VITE_SUPABASE_PUBLISHABLE_KEY }}" >> .env
          echo "VITE_SUPABASE_PROJECT_ID=${{ secrets.VITE_SUPABASE_PROJECT_ID }}" >> .env

      - name: Build do projeto
        run: npm run build

      - name: Mostrar arquivos gerados
        run: ls -al dist/

      - name: Deploy FTPS para Hostinger (sem apagar)
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          port: 21
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          protocol: ftps
          local-dir: dist/
          server-dir: ${{ env.DEPLOY_PATH }}
          dangerous-clean-slate: false
          dry-run: false
          log-level: verbose

      - name: Smoke test do site
        run: |
          echo "üåê Verificando status do site..."
          STATUS=$(curl -I -s -o /dev/null -w "%{http_code}" https://ramontech.com.br || echo "000")
          echo "üîé Status HTTP: $STATUS"
          if [ "$STATUS" != "200" ] && [ "$STATUS" != "301" ] && [ "$STATUS" != "302" ]; then
            echo "‚ö†Ô∏è Aten√ß√£o: o site n√£o retornou status esperado. Pode haver problema no caminho remoto, DNS ou SSL."
          else
            echo "‚úÖ Site acess√≠vel com sucesso!"
          fi
