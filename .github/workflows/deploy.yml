name: ğŸš€ Deploy do site na Hostinger via FTPS

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: ğŸ” Verificar repositÃ³rio
        uses: actions/checkout@v4

      - name: âš™ï¸ Configurar Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: ğŸ“¦ Instalar dependÃªncias
        run: npm ci

      - name: ğŸ—ï¸ Buildar projeto
        run: npm run build

      - name: ğŸ” Validar secrets obrigatÃ³rios
        run: |
          if [ -z "${{ secrets.FTP_HOST }}" ] || [ -z "${{ secrets.FTP_USER }}" ] || [ -z "${{ secrets.FTP_PASS }}" ]; then
            echo "âŒ ERRO: Secrets FTP obrigatÃ³rios ausentes!"
            exit 1
          fi
          echo "âœ… Secrets FTP detectados com sucesso."

      - name: ğŸ—‚ï¸ Definir caminho de deploy
        run: |
          if [ -z "${{ secrets.FTP_SERVER_DIR }}" ]; then
            echo "âš™ï¸ Usando DEPLOY_PATH=./ (raiz do FTP)"
            echo "DEPLOY_PATH=./" >> $GITHUB_ENV
          else
            RAW="${{ secrets.FTP_SERVER_DIR }}"
            NORM="./${RAW#./}"
            case "$NORM" in */) ;; *) NORM="$NORM/";; esac
            if echo "$NORM" | grep -q "public_html/public_html"; then
              echo "âŒ Caminho invÃ¡lido: $NORM"
              exit 1
            fi
            echo "âœ… Caminho de deploy definido: $NORM"
            echo "DEPLOY_PATH=$NORM" >> $GITHUB_ENV
          fi

      - name: ğŸ” Testar login FTP
        run: |
          echo "ğŸ” Testando conexÃ£o FTPS..."
          curl -v --ssl-reqd --ftp-ssl --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" "ftp://${{ secrets.FTP_HOST }}" || true

      - name: ğŸ“‚ Listar diretÃ³rio remoto antes do deploy
        run: |
          echo "ğŸ“ Listando conteÃºdo atual em ${{ env.DEPLOY_PATH }}"
          curl -v --ssl-reqd --ftp-ssl --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" "ftp://${{ secrets.FTP_HOST }}${{ env.DEPLOY_PATH }}" || true

      - name: ğŸš€ Enviar site pra Hostinger via FTPS
        id: deploy
        continue-on-error: true
        uses: SamKirkland/FTP-Deploy-Action@v4.3.4
        with:
          server: ${{ secrets.FTP_HOST }}
          username: ${{ secrets.FTP_USER }}
          password: ${{ secrets.FTP_PASS }}
          port: 21
          protocol: ftps
          server-dir: ${{ env.DEPLOY_PATH }}
          local-dir: dist/
          log-level: verbose
          dangerous-clean-slate: true

      - name: ğŸ§¾ Listar diretÃ³rio remoto apÃ³s deploy
        run: |
          echo "ğŸ“‚ ConteÃºdo final no servidor:"
          curl -v --ssl-reqd --ftp-ssl --user "${{ secrets.FTP_USER }}:${{ secrets.FTP_PASS }}" "ftp://${{ secrets.FTP_HOST }}${{ env.DEPLOY_PATH }}" || true

      - name: ğŸŒ Testar site online
        run: |
          echo "ğŸŒ Verificando status HTTPS..."
          curl -I https://www.ramontech.com.br

      - name: ğŸ§  Validar HTML no ar
        run: |
          HTML=$(curl -sL https://www.ramontech.com.br/index.html || true)
          echo "$HTML" | grep -q "<title>Ramon Tech" && echo "âœ… PÃ¡gina carregada com sucesso" || { echo "âŒ HTML inesperado"; exit 1; }

      # ------------------------
      # ğŸ” DiagnÃ³stico de erros detalhado
      # ------------------------
      - name: â— DiagnÃ³stico de erros de deploy
        if: failure()
        run: |
          echo "âš ï¸ Analisando logs de erro..."
          LOGS=$(cat $GITHUB_WORKSPACE/* || true)

          if echo "$LOGS" | grep -q "530"; then
            echo "âŒ ERRO 530: Falha de login no FTP (usuÃ¡rio ou senha incorretos)"
          elif echo "$LOGS" | grep -q "550"; then
            echo "âŒ ERRO 550: PermissÃ£o negada ou diretÃ³rio inexistente no servidor"
          elif echo "$LOGS" | grep -q "425"; then
            echo "âŒ ERRO 425: ConexÃ£o nÃ£o estabelecida com o servidor"
          elif echo "$LOGS" | grep -q "Timed out"; then
            echo "â° ERRO: Tempo de conexÃ£o excedido"
          elif echo "$LOGS" | grep -q "ENOTFOUND"; then
            echo "ğŸŒ ERRO: Host FTP nÃ£o encontrado â€” verifique o FTP_HOST"
          else
            echo "âš™ï¸ Nenhum erro padrÃ£o detectado. Veja os logs acima para detalhes tÃ©cnicos."
          fi
